<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face Crop & Background Removal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .container {
      padding-top: 50px;
    }

    .progress {
      height: 25px;
      display: none;
      margin-bottom: 15px;
    }

    #results ul {
      padding-left: 0;
    }

    #results li {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-view {
      margin-left: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 class="mb-4">Upload Images Folder</h1>

    <div class="mb-3">
      <label for="fileElem" class="form-label">Select a folder of images:</label>
      <input type="file" id="fileElem" multiple webkitdirectory directory class="form-control" accept="image/*">
    </div>

    <button id="uploadBtn" class="btn btn-primary mb-3">Upload & Process</button>
    <button id="downloadAllBtn" class="btn btn-success mb-3" style="display:none;">Download All</button>

    <div class="progress">
      <div class="progress-bar" role="progressbar" style="width:0%">0%</div>
    </div>

    <div id="results"></div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Processed Image</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="modalImage" src="" class="img-fluid" alt="Processed Image">
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const fileElem = document.getElementById('fileElem');
    const uploadBtn = document.getElementById('uploadBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const progress = document.querySelector('.progress');
    const progressBar = document.querySelector('.progress-bar');
    const resultsDiv = document.getElementById('results');

    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    const modalImage = document.getElementById('modalImage');

    uploadBtn.addEventListener('click', () => {
      const files = fileElem.files;
      if (!files.length) { alert('Please select a folder'); return; }

      progress.style.display = 'block';
      progressBar.style.width = '0%';
      progressBar.textContent = '0%';
      resultsDiv.innerHTML = '';
      downloadAllBtn.style.display = 'none';

      const total = files.length;
      let completed = 0;

      // Upload files one by one to show real progress
      const uploadFile = (index) => {
        if (index >= total) {
          // All files uploaded
          if (completed > 0) downloadAllBtn.style.display = 'inline-block';
          return;
        }

        const formData = new FormData();
        formData.append('images[]', files[index]);

        fetch('/upload', { method: 'POST', body: formData })
          .then(res => res.json())
          .then(data => {
            const res = data.results[0]; // single file response
            completed++;
            const percent = ((completed / total) * 100).toFixed(2);
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';

            let html = resultsDiv.innerHTML || '<ul class="list-group">';
            if (res.success) {
              html += `<li class="bg-white p-2">
                        ${res.original}
                        <div>
                          <button class="btn btn-sm btn-primary btn-view" data-src="/processed/${res.processed}">View</button>
                        </div>
                      </li>`;
            } else {
              html += `<li class="list-group-item text-danger">${res.original} ❌ ${res.error}</li>`;
            }
            resultsDiv.innerHTML = html + '</ul>';

            // Attach modal click events
            document.querySelectorAll('.btn-view').forEach(btn => {
              btn.addEventListener('click', () => {
                modalImage.src = btn.dataset.src;
                imageModal.show();
              });
            });

            // Next file
            uploadFile(index + 1);
          })
          .catch(err => {
            completed++;
            const percent = ((completed / total) * 100).toFixed(2);
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';

            let html = resultsDiv.innerHTML || '<ul class="list-group">';
            html += `<li class="list-group-item text-danger">${files[index].name} ❌ Upload failed</li>`;
            resultsDiv.innerHTML = html + '</ul>';

            uploadFile(index + 1);
          });
      };

      uploadFile(0); // start uploading first file
    });

    downloadAllBtn.addEventListener('click', () => {
      window.location.href = '/download_all';
    });
  </script>
</body>

</html>